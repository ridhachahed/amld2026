---
import WorkshopPartLayout from "@/layouts/WorkshopPartLayout.astro";

const title = "Part 3 ‚Äî Build a Hotel Booking Agent with HeatWave GenAI";
const baseUrl = import.meta.env.BASE_URL;

const exerciseNotebook = `${baseUrl}assets/notebooks/amld-heatwave-genai-lab.ipynb`;
const solutionNotebook = `${baseUrl}assets/notebooks/amld-heatwave-genai-lab-solution.ipynb`;
---

<WorkshopPartLayout
  title={title}
  description={title}
  partLabel="Part 3 of 3"
  heading="Build a Hotel Booking Agent with HeatWave GenAI"
  lead="From CRUD tools to RAG over invoices ‚Äî all inside MySQL HeatWave."
  active="rag"
>
  <section class="section">
    <div class="section-label">Architecture</div>
    <h2>The loop ‚Äî think ‚Üí call a tool ‚Üí observe ‚Üí answer</h2>
    <p>
      This lab uses a <strong>ReAct agent</strong> powered by HeatWave‚Äôs in-database LLM. Instead of hoping the model ‚Äúknows‚Äù your data,
      we give it tools to fetch it.
    </p>

    <div class="diagram-card">
      <div class="caption">Fig 7 ‚Äî Hotel booking agent (SQL tools + RAG tool)</div>

      <div class="mini-diagram" role="img" aria-label="Agent architecture ‚Äî user to ReAct agent, which calls SQL tools or a RAG tool backed by HeatWave.">
        <div class="mini-diagram__row">
          <div class="mini-diagram__box">User</div>
        </div>

        <div class="mini-diagram__row">
          <div class="mini-diagram__arrow">‚Üì</div>
        </div>

        <div class="mini-diagram__row">
          <div class="mini-diagram__box mini-diagram__box--agent">
            LangChain ReAct Agent
            <span>MyLLM (HeatWave) + tool descriptions</span>
          </div>
        </div>

        <div class="mini-diagram__row mini-diagram__row--tools">
          <div class="mini-diagram__box mini-diagram__box--sql">
            SQL Tools (CRUD)
            <span>search / book / cancel / update</span>
          </div>
          <div class="mini-diagram__box mini-diagram__box--db">
            MySQL HeatWave
            <span>data + inference + ML_RAG</span>
          </div>
          <div class="mini-diagram__box mini-diagram__box--rag">
            RAG Tool
            <span>invoice PDFs ‚Üí citations</span>
          </div>
        </div>
      </div>
    </div>

    <div class="notebook-downloads" aria-label="Notebook downloads">
      <a class="notebook-box notebook-box--exercise" href={exerciseNotebook} download>
        <div class="notebook-box__eyebrow">Notebook</div>
        <div class="notebook-box__title">Agent exercises</div>
        <div class="notebook-box__desc">Follow along and implement the missing tool code.</div>
        <div class="notebook-box__cta">Download ‚Üí</div>
      </a>

      <a class="notebook-box notebook-box--solution" href={solutionNotebook} download>
        <div class="notebook-box__eyebrow">Notebook</div>
        <div class="notebook-box__title">Solution (download at the end)</div>
        <div class="notebook-box__desc">Completed notebook for reference after the lab.</div>
        <div class="notebook-box__cta">Download ‚Üí</div>
      </a>
    </div>
  </section>

  <section class="section">
    <div class="section-label">Step 1</div>
    <h2>Connect to MySQL (sanity check)</h2>
    <p>
      In MySQL Studio, you already have credentials in the environment. Connect using <code>MYSQL_USER</code> and run a tiny query.
      If you see <code>(1,)</code>, you‚Äôre ready.
    </p>

    <div class="code-block">
      <pre><code>import os
import mysql.connector

mydb = mysql.connector.connect(database=os.environ["MYSQL_USER"])

cursor = mydb.cursor()
cursor.execute("SELECT 1")
print(cursor.fetchone())</code></pre>
    </div>
  </section>

  <section class="section">
    <div class="section-label">Step 2</div>
    <h2>Create an agent (and watch it fail)</h2>
    <p>
      Before building real tools, create a minimal agent backed by HeatWave‚Äôs in-database LLM. We add a placeholder tool,
      then ask it to book a hotel.
    </p>

    <div class="code-block">
      <pre><code>from mysql.ai.genai import MyLLM

from langchain_classic.agents.initialize import initialize_agent, AgentType
from langchain_core.tools import Tool

myllm = MyLLM(mydb).bind(model_id="meta.llama-3.3-70b-instruct")


dummy_tool = Tool(
    name="Placeholder",
    func=lambda x: "No real tools available yet.",
    description="A placeholder tool that does nothing useful.",
)


agent = initialize_agent(
    llm=myllm,
    tools=[dummy_tool],
    agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
    verbose=True,
    return_intermediate_steps=True,
    handle_parsing_errors=True,
    max_iterations=2,
    early_stopping_method="generate",
)

agent.invoke("Book the Hilton Basel for me!")</code></pre>
    </div>

    <div class="callout">
      <p><strong>Expected behavior</strong> ‚Äî it can‚Äôt actually book anything. Without tools, the agent has no way to read availability or update bookings.</p>
    </div>
  </section>

  <section class="section">
    <div class="section-label">Step 3</div>
    <h2>Introspect the <code>hotels</code> table</h2>
    <p>
      Tools are just functions. To write good tools, we need to know the schema.
      In this lab, the agent operates on a <code>hotels</code> table with booking state and optional dates.
    </p>

    <div class="code-block">
      <pre><code>import pandas as pd

pd.read_sql("SELECT * FROM hotels LIMIT 10", mydb)</code></pre>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th>Column</th>
          <th>Purpose</th>
        </tr>
      </thead>
      <tbody>
        <tr><td><code>id</code></td><td>Primary key used by tools</td></tr>
        <tr><td><code>name</code></td><td>Hotel name (e.g. Hilton Basel)</td></tr>
        <tr><td><code>location</code></td><td>City</td></tr>
        <tr><td><code>booked</code></td><td><code>1</code> booked, <code>0</code> available</td></tr>
        <tr><td><code>checkin_date</code> / <code>checkout_date</code></td><td>Reservation dates</td></tr>
      </tbody>
    </table>
  </section>

  <section class="section">
    <div class="section-label">Step 4</div>
    <h2>Give the agent hands ‚Äî CRUD tools</h2>
    <p>
      Now we create five tools. Each tool has (1) a Python function that runs SQL, and (2) a <code>Tool</code> wrapper with a name and description.
      The description is part of your ‚ÄúAPI‚Äù ‚Äî the LLM uses it to decide which tool to call and how to format the input.
    </p>

    <div class="info-grid">
      <div class="info-card">
        <div class="icon">üîé</div>
        <h3>Search</h3>
        <p>Find candidate hotels by location or name.</p>
      </div>
      <div class="info-card">
        <div class="icon">üßæ</div>
        <h3>Book / Cancel</h3>
        <p>Write to the database (set <code>booked</code> to 1 or 0).</p>
      </div>
      <div class="info-card">
        <div class="icon">üìÖ</div>
        <h3>Update dates</h3>
        <p>Parse <code>hotel_id, checkin, checkout</code> and update the row.</p>
      </div>
    </div>

    <h3>Tool 1 ‚Äî Search by location</h3>
    <div class="code-block">
      <pre><code>def search_hotels_by_location(location):
    location = location.split("\n")[0].strip()
    df = pd.read_sql("SELECT * FROM hotels WHERE location = %s", mydb, params=(location,))
    return df.to_json(orient="records")

search_hotels_by_location_tool = Tool(
    name="Search hotels by location",
    func=search_hotels_by_location,
    description="Search hotels by location.",
)</code></pre>
    </div>

    <div class="callout">
      <p><strong>Why sanitize the input?</strong> Tool inputs sometimes include extra text (newlines, commentary). Cleaning the string makes your SQL tools more robust.</p>
    </div>

    <h3>Try it</h3>
    <div class="code-block">
      <pre><code>tools = [search_hotels_by_location_tool]
agent = initialize_agent(
    llm=myllm,
    tools=tools,
    agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
    verbose=True,
    return_intermediate_steps=True,
    handle_parsing_errors=True,
    max_iterations=4,
    early_stopping_method="generate",
)

agent.invoke("Find me hotels in Basel?")</code></pre>
    </div>

    <h3>Tool 2 ‚Äî Search by name (fuzzy)</h3>
    <div class="code-block">
      <pre><code>def search_hotels_by_name(hotel_name):
    # SELECT * FROM hotels WHERE name LIKE %s
    # params=("%" + hotel_name + "%",)
    # return df.to_json(orient="records")
    # (Implemented in the notebook as an exercise)
    pass</code></pre>
    </div>

    <h3>Tool 3 ‚Äî Book a hotel (write)</h3>
    <div class="code-block">
      <pre><code>def book_hotel(hotel_id):
    # UPDATE hotels SET booked=1 WHERE id=%s AND booked=0
    # commit, raise if rowcount==0
    # (Implemented in the notebook as an exercise)
    pass</code></pre>
    </div>

    <h3>Tool 4 ‚Äî Cancel a booking</h3>
    <div class="code-block">
      <pre><code>def cancel_hotel(hotel_id):
    # UPDATE hotels SET booked=0 WHERE id=%s
    # commit
    # (Implemented in the notebook as an exercise)
    pass</code></pre>
    </div>

    <h3>Tool 5 ‚Äî Update check-in / check-out</h3>
    <p>
      LangChain tools accept a single string input, so we use a comma-separated contract.
      The tool description tells the model the exact format.
    </p>
    <div class="code-block">
      <pre><code>update_hotel_tool = Tool(
    name="Update hotel",
    func=update_hotel,
    description="Update hotel dates. Input: 'hotel_id, checkin_date, checkout_date' (e.g., '7, 2026-04-10, 2026-04-19')",
)</code></pre>
    </div>

    <div class="callout">
      <p><strong>Try a multi-action prompt</strong> ‚Äî ‚ÄúCancel Hilton Basel and book the Hyatt Regency instead.‚Äù A ReAct agent can chain multiple tool calls in one request.</p>
    </div>
  </section>

  <section class="section">
    <div class="section-label">Step 5</div>
    <h2>Add RAG ‚Äî answer pricing questions from invoices</h2>
    <p>
      The <code>hotels</code> table has no pricing. But invoices exist as PDFs in object storage.
      Load the PDF into HeatWave‚Äôs vector store (via the Chats UI), then create a tool that queries those documents.
    </p>

    <h3>Load the invoices into HeatWave vector store</h3>
    <ol>
      <li>Open the pre-authenticated request URL from the notebook.</li>
      <li>In MySQL Studio ‚Üí <strong>Chats</strong>, load the PDF into <strong>HeatWave vector store</strong>.</li>
      <li>Ask a pricing question to confirm retrieval works.</li>
    </ol>

    <h3>RAG tool design ‚Äî retrieve citations, let the agent answer</h3>
    <p>
      Call <code>sys.ML_RAG</code> with <code>skip_generate=true</code>. That returns relevant segments (citations) without a final narrative.
      Then the agent reads those segments and produces the final answer.
    </p>

    <div class="code-block">
      <pre><code>-- Retrieve relevant citations (no final generation)
CALL sys.ML_RAG(
  "input string",
  @response,
  JSON_OBJECT('skip_generate', true)
);
SELECT @response;</code></pre>
    </div>

    <div class="code-block">
      <pre><code>def rag(question):
    # 1) Call sys.ML_RAG(skip_generate=true)
    # 2) Parse JSON response
    # 3) Return a list of relevant invoice snippets
    # (Implemented in the notebook as an exercise)
    pass

rag_tool = Tool(
    name="Knowledge Base",
    func=rag,
    description="Useful for looking up hotel invoices.",
)</code></pre>
    </div>

    <h3>Test prompts</h3>
    <div class="code-block">
      <pre><code>agent.invoke("What is a price of accommodation at Hilton?")
agent.invoke("How much does a hotel room cost on average in the city of Bern?")</code></pre>
    </div>
  </section>

  <section class="section">
    <div class="section-label">Outcome</div>
    <h2>You now have an end-to-end agent</h2>
    <ul>
      <li><strong>CRUD via tools</strong> ‚Äî search, book, cancel, update dates</li>
      <li><strong>RAG via tools</strong> ‚Äî answer pricing questions from invoice PDFs</li>
      <li><strong>All inference in HeatWave</strong> ‚Äî no external LLM API calls</li>
    </ul>

    <div class="callout">
      <p><strong>Key takeaway</strong> ‚Äî tool descriptions are part of your ‚ÄúAPI‚Äù. Clear contracts (inputs/outputs) are what make agents reliable.</p>
    </div>
  </section>

  <style>
    .notebook-downloads {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-top: 14px;
    }

    @media (max-width: 720px) {
      .notebook-downloads {
        grid-template-columns: 1fr;
      }
    }

    .notebook-box {
      display: block;
      padding: 14px 14px 12px;
      border-radius: 14px;
      border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
      background: linear-gradient(
        135deg,
        color-mix(in oklab, var(--card) 88%, transparent),
        color-mix(in oklab, var(--accent) 18%, transparent)
      );
      box-shadow: var(--shadow-sm);
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
    }

    .notebook-box:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      border-color: color-mix(in oklab, var(--accent) 35%, var(--border));
    }

    .notebook-box__eyebrow {
      font-family: var(--workshop-font-mono);
      font-size: 11px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: var(--muted-foreground);
      margin-bottom: 6px;
    }

    .notebook-box__title {
      font-weight: 750;
      font-size: 16px;
      color: var(--foreground);
      margin-bottom: 6px;
    }

    .notebook-box__desc {
      color: var(--muted-foreground);
      font-size: 13px;
      line-height: 1.35;
      margin-bottom: 10px;
    }

    .notebook-box__cta {
      font-family: var(--workshop-font-mono);
      font-size: 12px;
      font-weight: 650;
      color: var(--foreground);
    }

    .notebook-box--exercise {
      background: linear-gradient(
        135deg,
        color-mix(in oklab, var(--card) 90%, transparent),
        color-mix(in oklab, var(--info) 16%, transparent)
      );
    }

    .notebook-box--exercise:hover {
      border-color: color-mix(in oklab, var(--info) 35%, var(--border));
    }

    .notebook-box--solution {
      background: linear-gradient(
        135deg,
        color-mix(in oklab, var(--card) 90%, transparent),
        color-mix(in oklab, var(--success) 16%, transparent)
      );
    }

    .notebook-box--solution:hover {
      border-color: color-mix(in oklab, var(--success) 35%, var(--border));
    }

    .mini-diagram {
      display: grid;
      gap: 12px;
      padding: 4px 0;
    }

    .mini-diagram__row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }

    .mini-diagram__row--tools {
      gap: 14px;
      flex-wrap: wrap;
    }

    .mini-diagram__arrow {
      font-family: var(--workshop-font-mono);
      color: var(--muted-foreground);
    }

    .mini-diagram__box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 700;
      color: var(--foreground);
      text-align: center;
      min-width: min(260px, 100%);
      box-shadow: var(--shadow-sm);
    }

    .mini-diagram__box span {
      display: block;
      margin-top: 4px;
      font-weight: 500;
      font-size: 12px;
      color: var(--muted-foreground);
    }

    .mini-diagram__box--agent {
      background: color-mix(in oklab, var(--info) 10%, var(--card) 90%);
    }

    .mini-diagram__box--sql {
      background: color-mix(in oklab, var(--info) 8%, var(--card) 92%);
    }

    .mini-diagram__box--db {
      background: color-mix(in oklab, var(--accent) 10%, var(--card) 90%);
    }

    .mini-diagram__box--rag {
      background: color-mix(in oklab, var(--success) 10%, var(--card) 90%);
    }
  </style>
</WorkshopPartLayout>
